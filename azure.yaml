name: react-app
metadata:
  subscription: ${AZURE_SUBSCRIPTION_ID}
  location: ${AZURE_LOCATION}

infra:
  bicep: ./infra/main.bicep

hooks:
  postdeploy:
    shell: pwsh
    continueOnError: false
    interactive: true
    run: ./azd-hooks/postdeploy.ps1
    env:
      AZURE_SUBSCRIPTION_ID: ${AZURE_SUBSCRIPTION_ID}
      AZURE_RESOURCE_GROUP: ${AZURE_RESOURCE_GROUP}
      SERVICE_API_IDENTITY_PRINCIPAL_NAME: ${SERVICE_API_IDENTITY_PRINCIPAL_NAME}
      POSTGRESQL_SERVER_NAME: ${POSTGRESQL_SERVER_NAME}
      POSTGRESQL_DATABASE_NAME: ${POSTGRESQL_DATABASE_NAME}
      AZURE_OPENAI_ENDPOINT: ${AZURE_OPENAI_ENDPOINT}
      AZURE_OPENAI_KEY: ${AZURE_OPENAI_KEY}
      AZURE_STORAGE_ACCOUNT_NAME: ${AZURE_STORAGE_ACCOUNT_NAME}
      AZURE_STORAGE_CONTAINER_NAME: ${AZURE_STORAGE_CONTAINER_NAME}
      STORAGE_EVENTGRID_SYSTEM_TOPIC_NAME: ${STORAGE_EVENTGRID_SYSTEM_TOPIC_NAME}
      DEPLOY_AML_MODEL: ${DEPLOY_AML_MODEL}
      AZURE_AML_WORKSPACE_NAME: ${AZURE_AML_WORKSPACE_NAME}
      AZURE_AML_ENDPOINT_NAME: ${AZURE_AML_ENDPOINT_NAME}

services:
  UserPortal:
    project: ./src/userportal
    host: containerapp
    language: js
    docker:
      context: ./
      registry: ${AZURE_CONTAINER_REGISTRY_ENDPOINT}
      path: DOCKERFILE
    hooks:
      prebuild:
        shell: pwsh
        continueOnError: false
        interactive: true
        run: |
          "REACT_APP_SERVICE_API_ENDPOINT_URL=$env:SERVICE_API_ENDPOINT_URL
          " | Out-File -FilePath ".env" -Encoding utf8
      postbuild:
        shell: pwsh
        continueOnError: false
        interactive: true
        run: |
          # Check if .env file exists
          if (Test-Path -Path ".env") {
              Remove-Item -Path ".env" -Force
              Write-Host ".env file deleted successfully"
          } else {
              Write-Host "Skipping: .env file does not exist"
          }
    dependsOn:
      - infra

  API:
    project: ./src/api
    host: containerapp
    language: python
    docker:
      context: ./
      path: DOCKERFILE
      registry: ${AZURE_CONTAINER_REGISTRY_ENDPOINT}
    dependsOn:
      - infra
