name: react-app
metadata:
  subscription: ${AZURE_SUBSCRIPTION_ID}
  location: ${AZURE_LOCATION}

infra:
  bicep: ./infra/main.bicep
  parameters:
    ownerId: ${OWNER_ID} # pass the OWNER_ID environment variable to the Bicep template

hooks:
  preprovision:
      shell: pwsh
      # Get the OwnerId of the signed-in user and set it as an environment variable
      run: |
        $ownerId = $(az ad signed-in-user show --query id -o tsv)
        Write-Output "Setting OWNER_ID environment variable to $ownerId"
        azd env set OWNER_ID $ownerId

  postdeploy:
    shell: pwsh
    continueOnError: false
    interactive: true
    run: ./azd-hooks/postdeploy.ps1
    env:
      AZURE_RESOURCE_GROUP: ${AZURE_RESOURCE_GROUP}
      SERVICE_API_IDENTITY_PRINCIPAL_NAME: ${SERVICE_API_IDENTITY_PRINCIPAL_NAME}
      POSTGRESQL_SERVER_NAME: ${POSTGRESQL_SERVER_NAME}
      POSTGRESQL_DATABASE_NAME: ${POSTGRESQL_DATABASE_NAME}
      AZURE_OPENAI_ENDPOINT: ${AZURE_OPENAI_ENDPOINT}
      AZURE_OPENAI_KEY: ${AZURE_OPENAI_KEY}

services:
  UserPortal:
    project: ./src/userportal
    host: containerapp
    language: js
    docker:
      context: ./
      registry: ${AZURE_CONTAINER_REGISTRY_ENDPOINT}
      path: DOCKERFILE
    dependsOn:
      - infra

  API:
    project: ./src/api
    host: containerapp
    language: python
    docker:
      context: ./
      path: DOCKERFILE
      registry: ${AZURE_CONTAINER_REGISTRY_ENDPOINT}
    dependsOn:
      - infra
