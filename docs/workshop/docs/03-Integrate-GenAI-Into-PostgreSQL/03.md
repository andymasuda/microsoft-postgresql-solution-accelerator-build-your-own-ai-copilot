# 3.3 Enable vector storage

The `azure_ai` extension allows you to generate embeddings for input text. To enable the generated vectors to be stored alongside the rest of your data in the database, you must leverage the capabilities of the **pgvector** extension.

## Add vector columns to tables

TODO: Determine the tables to which vector columns should be added.

1. Add the embedding vector column.

    The size of the vector column should correspond to the number of dimensions generated by the embedding model being used. For this solution, you will be using the `text-embedding-3-large` model, which is configured to return 3,072 dimensions, so use that is the size you should specify for each of your vector columns.

    ```sql
    ALTER TABLE listings ADD COLUMN listing_vector vector(1536);
    ```

## TODO

Now that we have some sample data, it's time to generate and store the embedding vectors. The `azure_ai` extension makes calling the Azure OpenAI embedding API easy.

    3. TODO: Run a quick query to show how it works against the SOW table for a single record

        

        ```sql
        azure_openai.create_embeddings(deployment)
        ```

    4. To provide a simplified example of using the function, run the following query, which creates a vector embedding for the `description` field in the `listings` table. The `deployment_name` parameter in the function is set to `embedding`, which is the name of the deployment of the `text-embedding-ada-002` model in your Azure OpenAI service (it was created with that name by the Bicep deployment script):

        ```sql
        SELECT
          id,
          name,
          azure_openai.create_embeddings('embedding', description) AS vector
        FROM listings
        LIMIT 1;
        ```
    
        The output looks similar to this:
    
        ```sql
         id |      name       |              vector
        ----+-------------------------------+------------------------------------------------------------
          1 | Stylish One-Bedroom Apartment | {0.020068742,0.00022734122,0.0018286322,-0.0064167166,...}
        ```

        For brevity, the vector embeddings are abbreviated in the above output.

        !!! info "[Embeddings](https://learn.microsoft.com/azure/postgresql/flexible-server/generative-ai-overview#embeddings) are a concept in machine learning and natural language processing (NLP) that involves representing objects such as words, documents, or entities, as [vectors](https://learn.microsoft.com/azure/postgresql/flexible-server/generative-ai-overview#vectors) in a multi-dimensional space. Embeddings allow machine learning models to evaluate how closely two pieces of information are related. This technique efficiently identifies relationships and similarities between data, allowing algorithms to identify patterns and make accurate predictions."

## Generate vector embeddings

TODO: Explain the capability... This might be better if moved to somewhere else, where it is actually going to be used...

The schema contains a single function, `create_embeddings()`, with two overloads. One overload accepts a single input string, and the other expects an array of input strings. You can view the details of the function, its overloads, and expected arguments in the (function documentation)[https://learn.microsoft.com/azure/postgresql/flexible-server/generative-ai-azure-openai#azure_openaicreate_embeddings].

    ```sql
    -- Single text input
    azure_openai.create_embeddings(deployment_name text, input text, timeout_ms integer DEFAULT 3600000, throw_on_error boolean DEFAULT true, max_attempts integer DEFAULT 1, retry_delay_ms integer DEFAULT 1000)
    
    -- Array of input text
    azure_openai.create_embeddings(deployment_name text, input text[], batch_size integer DEFAULT 100, timeout_ms integer DEFAULT 3600000, throw_on_error boolean DEFAULT true, max_attempts integer DEFAULT 1, retry_delay_ms integer DEFAULT 1000)
    ```

TODO: Run a predefined script against the altered tables to generate embeddings for each row of text...

1. Generate an embedding vector for the description of each listing by calling Azure OpenAI through the create_embeddings user-defined function, which is implemented by the azure_ai extension:

    ```sql
    UPDATE listings
    SET listing_vector = azure_openai.create_embeddings('embedding', description, max_attempts => 5, retry_delay_ms => 500)
    WHERE listing_vector IS NULL;
    ```

    Note that this may take several minutes, depending on the available quota.

2. See an example vector by running this query:

    ```sql
    SELECT listing_vector FROM listings LIMIT 1;
    ```

    You will get a result similar to this, but with 1536 vector columns:

    ```sql
    postgres=> SELECT listing_vector FROM listings LIMIT 1;
    -[ RECORD 1 ]--+------ ...
    listing_vector | [-0.0018742813,-0.04530062,0.055145424, ... ]
    ```

!!! success "CONGRATULATIONS. You just learned how to add vector storage and search capabilities to Azure Database for PostgreSQL!"


