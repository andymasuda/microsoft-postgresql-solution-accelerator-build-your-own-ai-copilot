# 6.5 Enable AGE

The **Apache AGE** (`age`) extension enhances PostgreSQL by allowing it to be used as a graph database, providing a comprehensive solution for analyzing interconnected data. With `age`, you can define and query complex data relationships using graph structures. Before using AGE, add it to the PostgreSQL server's _allowlist_, configure it as a shared preloaded library, and install it in your database.

## Allowlist the extension

Before installing and using extensions in Azure Database for PostgreSQL flexible server, you must add them to the server's _allowlist_, as described in [how to use PostgreSQL extensions](https://learn.microsoft.com/azure/postgresql/extensions/how-to-allow-extensions).

_Select the tab for the method you want to use for allowlisting the extensions and follow the instructions provided._

=== "Azure CLI"

    1. Open a new integrated terminal window in VS Code and execute the following Azure CLI command at the prompt.

    !!! note "Ensure you replace the tokens in the command below with the appropriate values from your Azure environment."

        - **[YOUR_RESOURCE_GROUP]**: The name of the resource group hosting your Azure Database for PostgreSQL flexible server.
        - **[YOUR_POSTGRESQL_SERVER]**: The name of your Azure Database for PostgreSQL server.
        - **[YOUR_SUBSCRIPTION_ID]**: Your Azure subscription ID.
    
    ```bash
    az postgres flexible-server parameter set --resource-group [YOUR_RESOURCE_GROUP] --server-name [YOUR_POSTGRESQL_SERVER] --subscription [YOUR_SUBSCRIPTION_ID] --name azure.extensions --value age
    ```

=== "Azure portal"

    1. Navigate to your Azure Database for PostgreSQL flexible server instance in the [Azure portal](https://portal.azure.com/).

    2. From the left-hand resource menu:
        1. Expand the **Settings** section and select **Server parameters**.
        2. Enter "azure.extensions" into the search filter.
        3. Expand the **VALUE** dropdown list.
        4. Select the **AGE** extension by checking the its box in the **VALUE** dropdown list.

        ![Screenshot of the steps to allowlist the AGE extension in the Azure portal.](../img/allow-extensions-age.png)

## Load AGE on server start

Some Postgres libraries need to perform certain operations that can only take place at postmaster start, such as allocating shared memory, reserving lightweight locks, or starting background workers. `AGE` relies on shared memory for its operations, so it must be loaded at server start. The `shared_preload_libraries` parameter in PostgreSQL is used to specify libraries that should be loaded at server startup, enabling additional functionalities or extensions before any connections are made.

_Select the tab for the method you want to use for updating the `shared_preload_libraries` parameter and follow the instructions provided._

=== "Azure CLI"

    1. In the VS Code integrated terminal window, execute the following Azure CLI command at the prompt.

    !!! note "Ensure you replace the tokens in the command below with the appropriate values from your Azure environment."

        - **[YOUR_RESOURCE_GROUP]**: The name of the resource group hosting your Azure Database for PostgreSQL flexible server.
        - **[YOUR_POSTGRESQL_SERVER]**: The name of your Azure Database for PostgreSQL server.
        - **[YOUR_SUBSCRIPTION_ID]**: Your Azure subscription ID.
    
    ```bash
    az postgres flexible-server parameter set --resource-group [YOUR_RESOURCE_GROUP] --server-name [YOUR_POSTGRESQL_SERVER] --subscription [YOUR_SUBSCRIPTION_ID] --name shared_preload_libraries --value age,pg_cron,pg_stat_statements
    ```

    !!! info "`pg_cron` and `pg_stat_statements` are set by default, so they are included in the above command to avoid removing them from the `shared_preload_libraries` parameter."

=== "Azure portal"

    1. On the **Server parameters** page of your Azure Database for PostgreSQL flexible server instance in the [Azure portal](https://portal.azure.com/):

        1. Enter "shared_preload" into the search filter.
        2. Expand the **VALUE** dropdown list.
        3. Select the **AGE** extension by checking the its box in the **VALUE** dropdown list.
        4. Select **Save** on the toolbar.

        ![Screenshot of the steps to add AGE to the shared_preload_libraries parameter in the Azure portal.](../img/shared-preload-libraries-add-age.png)

    2. Select **Save** will trigger a restart of the PostgreSQL server and will take a few seconds to complete. 

## Install AGE

With the `AGE` extension added to the _allowlist_ and loaded on your PostgreSQL server, you can install it in your database using the [CREATE EXTENSION](https://www.postgresql.org/docs/current/sql-createextension.html) command.

!!! warning "At this time, the AGE extension is in preview and will only be available for newly created Azure Database for PostgreSQL Flexible Server instances running at least PG13 up to PG16."

You will use **pgAdmin** to install the extension by executing a SQL command against your database.

1. On your local machine, return to the open instance of **pgAdmin** (or open it if you closed it after the setup tasks) and ensure it is connected to your PostgreSQL database.

2. In the pgAdmin **Object Explorer**, expand databases under your PostgreSQL server.

3. Right-click the **contracts** database and select **Query Tool** from the context menu.

4. Install the `age` extension by running the following `CREATE EXTENSION` command in the pgAdmin query window:

    ```sql title=""
    CREATE EXTENSION IF NOT EXISTS age;
    ```
