# 4.3 Summarize documents

_TODO: Use the `azure_ai` extension's `azure_cognitive` schema to perform abstractive summarization on SOWs (and invoices?)._

_TODO: Summaries should be created using the extension as part of an update statement on the tables._

_TODO: Perhaps have a button on the UI that kicks off the summarization process, or should it be part of the ingestion process? If so, the docs here will need to have them build the final insert queries over a few steps and then run it at the end, so minor restructuring, but probably the right way to go._

Leverage the `azure_ai` extension's `azure_cognitive` schema to perform abstractive summarization on SOWs (Statements of Work). This feature provides natural-language summaries that effectively encapsulate the intent and key details of the original text.

## Abstractive Summarization

The extension's abstractive summarization capabilities provide a unique, natural-language summary that encapsulates the overall intent of the original text. This is performed by calling the `azure_cognitive.summarize_abstractive` function within the database. This will generate a 2-3 sentence summary of the text passed in.

```psql
azure_cognitive.summarize_abstractive('This is a document text', 'en', 2)
```

If you receive an error similar to the following, you chose a region that does not support abstractive summarization when creating your Azure environment:

```bash
ERROR: azure_cognitive.summarize_abstractive: InvalidRequest: Invalid Request.
InvalidParameterValue: Job task: 'AbstractiveSummarization-task' failed with validation errors: ['Invalid Request.']
InvalidRequest: Job task: 'AbstractiveSummarization-task' failed with validation error: Document abstractive summarization is not supported in the region Central US. The supported regions are North Europe, East US, West US, UK South, Southeast Asia.
```

To be able to perform this step and complete the remaining tasks using abstractive summarization, you must create a new Azure AI Language service in one of the supported regions specified in the error message. This service can be provisioned in the same resource group you used for other lab resources.

Alternatively, you may substitute extractive summarization using the `azure_cognitive.summarize_extractive` function for the remaining tasks but will not get the benefit of being able to compare the output of the two different summarization techniques.

```psql
azure_cognitive.summarize_extractive('This is a document text', 'en', 2)
```

## Insert Document Summary on Database Insert

Leveraging the `azure_cognitive.summarize_abstrative` method of the `azure_ai` extension, the database scripts are able to make calls to generate a document summary on INSERT or UPDATE.

Here's an example INSERT script used by the application when creating SOW records that includes the summarization:

```psql
INSERT INTO sows (number, start_date, end_date, budget, document, metadata, embeddings, summary, vendor_id)
VALUES (
    $1, $2, $3, $4, $5, $6, 
    azure_openai.create_embeddings('embeddings', $7, throw_on_error => FALSE, max_attempts => 1000, retry_delay_ms => 2000),
    azure_cognitive.summarize_abstractive($7, 'en', 2)
    $8)
RETURNING *;
```
