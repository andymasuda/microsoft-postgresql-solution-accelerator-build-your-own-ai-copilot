# 5.4 Review RAG Implementation

1. Implement RAG (Function calling review)
   1. Show how to use LangChain's `StructuredTool` (or whatever it is) to call existing functions to get info from the database for RAG
   2. Embed incoming user messages for similarity search and semantic ranker capablities

## Hybrid Search

Hybrid search in Azure Database for PostgreSQL ingeniously combines full-text search with vector similarity search to deliver highly relevant results. This dual approach leverages the precision of keyword matching with full-text search and the contextual understanding of vector search, ensuring that users obtain both exact matches and semantically related content. This synergy enhances search efficiency, provides a richer user experience, and supports diverse use cases—from technical document retrieval to broad content discovery—making it an invaluable tool for modern data querying needs.

### Why Hybrid Search in Azure Database for PostgreSQL is Better

1. **Comprehensive Results**
    - **Full-Text Search**: Uses keyword matching for precise term searches.
    - **Vector Search**: Uses vector similarity to find contextually relevant results.
    - **Hybrid**: Combines both to ensure exact and semantically similar results.

2. **Enhanced Relevance**
    - Prioritizes exact matches from full-text search while including contextually significant results from vector search.

3. **Improved User Experience**
    - Balances precision (full-text) and relevance (vector) for satisfying search outcomes.

4. **Versatility**
    - Supports varied use cases from technical documents to content discovery by integrating both search techniques.

5. **Efficient Resource Use**
    - Optimizes search efficiency by leveraging both full-text and vector search.

By integrating full-text search and vector similarity search, hybrid search maximizes the relevance and comprehensiveness of search results, providing users with more accurate and meaningful information.

To allow search results against the database to use traditional full-text search combined with vector similarity seearch, you can combine both approaches in a single query to leverage the strengths of traditional keyword search and vector similarity search.

TODO: Add details about how hybrid search is better than either of its two components.

You can use a CASE statement to adjust the ranking based on both the keyword match and the vector similarity. Here's an example of how to do it:

```sql
SELECT *,
    CASE
        WHEN result ILIKE '%search_term%' THEN 0 -- Exact match ranks highest
        ELSE vector_distance(vector_field, vector_generate('search_term'))
    END AS rank
FROM invoice_valition_results
ORDER BY rank ASC
LIMIT 10;
```

In this query:

- The CASE statement assigns a rank of 0 to rows where text_field contains the exact search term (ILIKE '%search_term%').

- For all other rows, the rank is based on the vector distance, which ensures that semantically similar results are included.

- The results are then ordered by the rank, with exact matches ranking highest, followed by the most semantically similar results.

- Finally, we limit the results to the top 100.

This approach allows you to prioritize exact keyword matches while still incorporating the benefits of vector similarity search.

TODO: Test the above, and implement something like also restricting to a particular vendor?
